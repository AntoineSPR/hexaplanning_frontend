<svg
  id="hexmap"
  [attr.viewBox]="'0 0 ' + mapWidth + ' ' + mapHeight"
  preserveAspectRatio="xMidYMid meet"
  (mousedown)="onSvgMouseDown($event)"
  (mousemove)="onSvgMouseMove($event)"
  (mouseup)="onSvgMouseUp($event)"
  (mouseleave)="onSvgMouseLeave($event)"
  (wheel)="onSvgWheel($event)"
  (touchstart)="onTouchStart($event)"
  (touchmove)="onTouchMove($event)"
  (touchend)="onTouchEnd($event)"
  (touchcancel)="onTouchEnd($event)"
  [style.cursor]="isPanning ? 'grabbing' : 'grab'"
  style="user-select: none; touch-action: none">
  <!-- Define clipping paths for each hexagon -->
  <defs>
    @for (h of hexes; track $index) {
    <clipPath [attr.id]="getHexClipId(h)">
      <polygon [attr.points]="getHexPoints(h.cx, h.cy)" />
    </clipPath>
    }
  </defs>

  <!-- Camera transform group -->
  <g [attr.transform]="getCameraTransform()">
    @for (h of hexes; track $index) {
    <!-- Base hexagon -->
    <polygon
      [attr.points]="getHexPoints(h.cx, h.cy)"
      stroke="black"
      stroke-width="1"
      [attr.fill]="getHexColor(h)"
      (click)="handleHexClick(h)"
      (keydown)="handleHexKeydown($event, h)"
      tabindex="0"
      role="button"
      [attr.aria-label]="getHexAriaLabel(h)"
      class="hex-polygon" />

    <!-- Progress overlay (if quest has advancement and is in progress) -->
    @if (h.quest && getQuestAdvancement(h) > 0 && h.quest.statusId === '2281c955-b3e1-49dc-be62-6a7912bb46b3') {
    <path
      [attr.d]="getProgressPath(h.cx, h.cy, getQuestAdvancement(h))"
      [attr.fill]="'var(--dark-theme-color)'"
      [attr.clip-path]="'url(#' + getHexClipId(h) + ')'"
      stroke="none"
      (click)="handleHexClick(h)"
      tabindex="-1"
      role="presentation" />
    }

    <!-- Border -->
    <polygon
      [attr.points]="getHexPoints(h.cx, h.cy, -2)"
      [attr.stroke]="getHexBorderColor(h)"
      [attr.stroke-width]="2"
      fill="none"
      (click)="handleHexClick(h)"
      tabindex="-1"
      role="presentation" />
    <foreignObject
      class="hex_text_wrapper"
      [attr.x]="h.cx - size * 0.75"
      [attr.y]="h.cy - size * 0.75"
      [attr.width]="size * 1.5"
      [attr.height]="size * 1.2">
      @if (h.quest) {
      <!-- Unassign button -->
      <button class="quest-delete" (click)="deleteQuestFromHex(h, $event)">X</button>
      }
      <!-- Quest title -->
      <xhtml:div xmlns="http://www.w3.org/1999/xhtml" class="hex_text_container">
        <div class="hex_quest_title">
          {{ h.quest?.title || '' }}
        </div>
      </xhtml:div>
    </foreignObject>
    }
  </g>
</svg>

<!-- Camera controls -->
<div class="camera-controls">
  <button class="camera-reset-btn" (click)="resetCamera()" title="Réinitialiser la vue">
    <i class="pi pi-refresh"></i>
  </button>
  <div class="zoom-indicator">{{ (zoom * 100).toFixed(0) }}%</div>
</div>

<p-dialog class="select-dialog" [(visible)]="dialogVisible" [modal]="true" [dismissableMask]="true">
  <ng-template #header>
    @if (selectedHex) {
    <h3>Assigner une quête à accomplir</h3>
    }
  </ng-template>

  <div class="quest-selection">
    <div class="quest-list">
      @if (unassignedPendingQuests.length === 0) {
      <p>Aucune nouvelle quête à accomplir !</p>
      } @else { @for (quest of unassignedPendingQuests; track quest.id) {
      <div class="quest-item quest-card" (click)="selectQuest(quest)" [class.selected]="selectedQuest?.id === quest.id">
        <p-radioButton [value]="quest" [(ngModel)]="selectedQuest" [inputId]="'quest_' + quest.id"> </p-radioButton>
        <label [for]="'quest_' + quest.id" class="ml-2"> {{ quest.title }} </label>
        <img
          class="priority-icon"
          [src]="getPriorityImagePath(quest)"
          [alt]="getPriorityAltText(quest)"
          [class]="'priority-' + getPriorityIcon(quest)" />
      </div>
      } }
    </div>
  </div>
  <ng-template #footer>
    <p-button label="Annuler" icon="pi pi-times" (click)="dialogVisible = false" styleClass="p-button-text"> </p-button>
    <p-button label="Assigner" icon="pi pi-check" (click)="assignQuestToHex()" [disabled]="!selectedQuest"> </p-button>
  </ng-template>
</p-dialog>

<!-- Confirmation dialog for quest unassignment -->
<p-confirmdialog #cd>
  <ng-template #headless let-message let-onAccept="onAccept" let-onReject="onReject">
    <div class="confirmation-dialog">
      <p>{{ message.message }}</p>
      <div class="flex items-center gap-2 justify-content-end">
        <button type="button" class="cancel-confirmation-button" (click)="onReject()" styleClass="w-32">Annuler</button>
        <button type="button" class="accept-confirmation-button" (click)="onAccept()" styleClass="w-32">Retirer</button>
      </div>
    </div>
  </ng-template>
</p-confirmdialog>

<app-menu></app-menu>
